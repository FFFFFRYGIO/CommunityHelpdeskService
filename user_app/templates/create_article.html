{% extends 'base.html' %}

{% block title %}Create Article Page{% endblock %}

{% block content %}
    <h1>Create Article</h1>
    {% if user.is_authenticated %}
        <form action="#" method="post" class="form-group" id="article-form">
            {% csrf_token %}
            {{ article_form.as_p }}
            {{ step_form_set.management_form }}
            {{ step_form_set.non_form_errors }}
            <div id="steps-formset">
                {% for step_form in step_form_set %}
                    <div class="step-form">
                        <h4>Step 1</h4>
                        {{ step_form.as_p }}
                        <br>
                    </div>
                {% endfor %}
            </div>
            <a href="#" id="remove-step-button" class="btn btn-secondary remove-step-button">Remove Step</a>
            <a href="#" id="add-step-button" class="btn btn-secondary add-step-button">Add Another Step</a>
            <button type="submit" class="btn btn-success" value="Save">Save</button>

        </form>
    {% else %}
        <h3>User isn't authenticated, login <a href="/registration/login">HERE</a></h3>
    {% endif %}
    <script>
        let addStepButton = document.getElementById("add-step-button");
        let removeStepButton = document.getElementById("remove-step-button");
        let stepsFormset = document.getElementById("steps-formset");
        let stepForms = document.querySelectorAll(".step-form");
        let totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');

        addStepButton.addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("add-step-button")) {
                e.preventDefault();
                let newStepForm = stepForms[0].cloneNode(true);
                newStepForm.innerHTML = newStepForm.innerHTML.replace(/form-0/g, "form-" + totalFormsInput.value);
                totalFormsInput.value = parseInt(totalFormsInput.value, 10) + 1;
                newStepForm.innerHTML = newStepForm.innerHTML.replace(/Step 1/g, "Step " + totalFormsInput.value);
                stepsFormset.appendChild(newStepForm);
            }
        });
        removeStepButton.addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("remove-step-button")) {
                e.preventDefault();
                if (totalFormsInput.value > 1) {
                    stepsFormset.removeChild(stepsFormset.lastChild);
                    totalFormsInput.value = parseInt(totalFormsInput.value, 10) - 1;
                } else {
                    alert("You have to have at least 1 step");
                }
            }
        });
    </script>
{% endblock %}
